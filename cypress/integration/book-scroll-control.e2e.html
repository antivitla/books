<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Test infinite book scroll</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="../../src/book-fragment.js"></script>
  <script src="../../src/book-scroll.js"></script>
  <script src="../../src/binary-search.js"></script>
  <script src="../../src/book-scroll-position.js"></script>
  <script src="../../src/book-scroll-control.js"></script>
  <style>
    body {
      margin: 0;
    }
    book-scroll {
      height: 100vh;
    }
    .part {
      padding: 1rem 1.5rem;
      box-sizing: border-box;
      border: solid 5px;
      border-bottom: 0;
      font-size: 18px;
      overflow: hidden;
      /* display: flex; */
      /* flex-direction: column; */
    }
    .part > div {
      flex-grow: 1;
      height: 20%;
      outline: solid crimson 1px;
    }
    .part:last-child {
      border-bottom: solid 5px;
    }
    .hidden {
      display: none;
    }
    .color-0 { background-color: lightskyblue; }
    .color-1 { background-color: limegreen; }
    .color-2 { background-color: sandybrown; }
    .color-3 { background-color: antiquewhite; }
    .color-4 { background-color: beige; }
    .color-5 { background-color: burlywood; }
    .color-6 { background-color: cornsilk; }
    .color-7 { background-color: coral; }
    .color-8 { background-color: darkkhaki; }
    .color-9 { background-color: darksalmon; }
    .margin {
      position: absolute;
      top: 5vh;
      left: 0;
      right: 0;
      height: 2px;
      background-color: blue;
    }
  </style>
</head>
<body>
<div class="margin"></div>
<book-scroll-control for="book-scroll" type="url"></book-scroll-control>
<book-scroll-control for="book-scroll" type="scrollbar" scroll-threshold="100"></book-scroll-control>

<book-scroll-position for="book-scroll" margin="0.05" depth="2"></book-scroll-position>
<book-scroll id="book-scroll"></book-scroll>
<script>
  (function () {
    // Mock options
    const urlParams = new URL(location.href).searchParams;
    const partsCount = parseInt(urlParams.get('count'), 10) || 30;
    const partSizeVh = parseInt(urlParams.get('size'), 10) || 10;
    const activationMargin = urlParams.get('margin') || '1000px 0px';
    const generateNext = urlParams.get('generateNext') === 'true' || false;
    const generatePrevious = urlParams.get('generatePrevious') === 'true' || false;
    const initiallyInactive = urlParams.get('inactive') || false;

    // Scroll root
    const bookScroll = document.querySelector('book-scroll');
    bookScroll.setAttribute(
      'activation-margin', activationMargin.match(/^\d+$/) ? `${activationMargin}px 0px` : activationMargin
    );

    // Add/remove content
    bookScroll.addEventListener('book-scroll-next', event => {
      if (generateNext) {
        console.log('book-scroll-next');
        event.target.addNextSection(generatePart(`part-id-${event.target.children.length}`))
      }
    });
    bookScroll.addEventListener('book-scroll-previous', event => {
      if (generatePrevious) {
        console.log('book-scroll-previous');
        event.target.addPreviousSection(generatePart(`part-id-${event.target.children.length}`))
      }
    });

    // Generate parts
    function generatePart(id) {
      const part = document.createElement('book-fragment');
      if (!initiallyInactive) {
        part.setAttribute('active', '');
      }
      part.id = id;
      part.className = `part color-${parseInt(Math.random() * 10, 10)}`;
      part.style.height = `${partSizeVh + (Math.random() * partSizeVh * 2)}vh`;
      return part;
    }
    const fragment = document.createDocumentFragment();
    for (let i = 0; i < partsCount; i++) {
      fragment.append(generatePart(`part-id-${i}`));
    }
    bookScroll.append(fragment);

    // Fill with random text
    fetch('https://fish-text.ru/get?type=sentence&number=40')
      .then(response => response.json())
      .then(json => json.text)
      .then(text => {
        const lines = text.split('. ');
        const parts = Array.from(bookScroll.querySelectorAll('.part:not(.measure)'));
        parts.forEach((part, index) => {
          const size = Math.round(3 + Math.random()*3);
          const html = lines[index].split(' ').slice(0,size).map(word => {
            return `<div style="height: ${100 / size}%">${word}</div>`
          }).join(' ');
          if (part.active) {
            part.innerHTML = html;
          } else {
            part.children[0].innerHTML = html;
          }
        });
      })
      .finally(() => {
        setTimeout(() => {
          const scrollbar = document.querySelector('book-scroll-control[type="scrollbar"]');
          scrollbar.clearScrollbarCache();
          document.querySelector('book-scroll-position').emitPositionChange();
        }, 500);
      });
  }());
</script>
</body>
</html>
